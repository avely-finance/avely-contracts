scilla_version 0

import IntUtils

(***************************************************)
(*               Associated library                *)
(***************************************************)
library MinterProxy

let uint128_one = Uint128 1

let one_msg =
  fun (msg : Message) =>
    let nil_msg = Nil {Message} in
    Cons {Message} msg nil_msg

contract MinterProxy(
  init_azil_address         : ByStr20,
  init_zilswap_address      : ByStr20
)

field azil_address          : ByStr20 = init_azil_address
field zilswap_address       : ByStr20 = init_zilswap_address

(************************************************************)
(* @dev: Procedures                                         *)
(************************************************************)

(* procedure ThrowError(err: Error)
  e = make_error err;
  throw e
end *)

procedure SwapExactZILForTokens(amount: Uint128, min_azil_amount: Uint128, deadline_block: BNum)
  token_address <- azil_address;
  zilswap_addr <- zilswap_address;

  current_block <- & BLOCKNUMBER;
  deadline_block = builtin badd current_block uint128_one;
  recipient_address = _sender;

  msg = {_tag: "SwapExactZILForTokens"; _recipient: zilswap_addr; _amount: amount;
          token_address: token_address; min_token_amount: min_azil_amount;
          deadline_block: deadline_block; recipient_address: recipient_address};
  msgs = one_msg msg;
  send msgs
end

transition Mint(min_azil_amount: Uint128, deadline_block: BNum)
  accept;
  amount = _amount;

  current_block <- & BLOCKNUMBER;
  is_not_expired = builtin blt current_block deadline_block;
  match is_not_expired with
  | True =>
    (*  *)
    SwapExactZILForTokens amount min_azil_amount deadline_block
  | False =>
    (* Use AZil for direct stake *)
  end
end
